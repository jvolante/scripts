#!/usr/bin/env bash
# Check if a git branch has been merged into another branch
#
# Usage: git-is-merged [source-branch] [target-branch]
#   source-branch: Branch to check (default: current branch)
#   target-branch: Branch to check against (default: repository default branch)
#
# Detects:
#   - Regular merge commits
#   - Squash merges
#   - Rebase merges

set -euo pipefail

# Get the source branch (default to current branch)
if [ -n "${1:-}" ]; then
    SOURCE_BRANCH="$1"
else
    SOURCE_BRANCH=$(git rev-parse --abbrev-ref HEAD)
fi

# Get the target branch (default to repository default branch)
if [ -n "${2:-}" ]; then
    TARGET_BRANCH="$2"
else
    # Try to get the default branch from remote
    TARGET_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "master")
fi

printf "Checking if branch '%s' has been merged into '%s'...\n" "$SOURCE_BRANCH" "$TARGET_BRANCH"

# Check if both branches exist
if ! git rev-parse --verify "$SOURCE_BRANCH" >/dev/null 2>&1; then
    printf "Error: Branch '%s' does not exist\n" "$SOURCE_BRANCH" >&2
    exit 1
fi

if ! git rev-parse --verify "$TARGET_BRANCH" >/dev/null 2>&1; then
    printf "Error: Branch '%s' does not exist\n" "$TARGET_BRANCH" >&2
    exit 1
fi

# Get the merge base
MERGE_BASE=$(git merge-base "$SOURCE_BRANCH" "$TARGET_BRANCH")

# Get the commit hash of the source branch
SOURCE_COMMIT=$(git rev-parse "$SOURCE_BRANCH")

# Method 1: Check if merge base equals source commit (regular merge)
if [ "$MERGE_BASE" = "$SOURCE_COMMIT" ]; then
    printf "Branch '%s' has been merged into '%s' (regular merge)\n" "$SOURCE_BRANCH" "$TARGET_BRANCH"
    exit 0
fi

# Method 2: Check patch-ids to detect rebase merges
# Get patch-ids for all commits in source branch not in target
SOURCE_PATCH_IDS=$(git log "$TARGET_BRANCH".."$SOURCE_BRANCH" --pretty=format:"%H" | \
    while read -r commit; do
        git show "$commit" | git patch-id --stable
    done | awk '{print $1}' | sort)

if [ -z "$SOURCE_PATCH_IDS" ]; then
    # No commits to check
    printf "Branch '%s' has been merged into '%s'\n" "$SOURCE_BRANCH" "$TARGET_BRANCH"
    exit 0
fi

# Get patch-ids for recent commits in target branch
# Check commits since the merge base to avoid scanning entire history
TARGET_PATCH_IDS=$(git log "$MERGE_BASE".."$TARGET_BRANCH" --pretty=format:"%H" | \
    while read -r commit; do
        git show "$commit" | git patch-id --stable
    done | awk '{print $1}' | sort)

# Check if all source patch-ids exist in target
ALL_FOUND=true
while IFS= read -r patch_id; do
    if ! printf "%s\n" "$TARGET_PATCH_IDS" | grep -q "^$patch_id$"; then
        ALL_FOUND=false
        break
    fi
done <<< "$SOURCE_PATCH_IDS"

if [ "$ALL_FOUND" = true ]; then
    printf "Branch '%s' has been merged into '%s' (rebase merge detected via patch-id)\n" "$SOURCE_BRANCH" "$TARGET_BRANCH"
    exit 0
fi

# Create a temporary tree with source changes applied to target
# Check if the changes in source are already in target
if git diff "$MERGE_BASE".."$SOURCE_BRANCH" --quiet 2>/dev/null; then
    # No actual changes between merge base and source
    printf "Branch '%s' has been merged into '%s' (no unique changes)\n" "$SOURCE_BRANCH" "$TARGET_BRANCH"
    exit 0
fi

# Check if the changes from source exist in targe by looking for a commit
# in target that has the same tree or diff
SOURCE_DIFF=$(git diff "$MERGE_BASE" "$SOURCE_BRANCH" | git patch-id --stable | awk '{print $1}')

# Check if this exact diff appears in any commit reachable from target
while read -r commit; do
    PARENT=$(git rev-parse "$commit"^1 2>/dev/null || echo "")
    if [ -n "$PARENT" ]; then
        COMMIT_PATCH_ID=$(git diff "$PARENT" "$commit" | git patch-id --stable | awk '{print $1}')
        if [ "$COMMIT_PATCH_ID" = "$SOURCE_DIFF" ]; then
            printf "Branch '%s' has been merged into '%s' (squash merge detected via diff matching)\n" "$SOURCE_BRANCH" "$TARGET_BRANCH"
            exit 0
        fi
    fi
done < <(git rev-list "$MERGE_BASE".."$TARGET_BRANCH")

# Not merged
printf "Branch '%s' has NOT been merged into '%s'\n" "$SOURCE_BRANCH" "$TARGET_BRANCH"
COMMIT_COUNT=$(git rev-list --count "$TARGET_BRANCH".."$SOURCE_BRANCH")
printf "  Commits in '%s' not in '%s': %s\n" "$SOURCE_BRANCH" "$TARGET_BRANCH" "$COMMIT_COUNT"
exit 1
