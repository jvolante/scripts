#!/usr/bin/env bash
set -euo pipefail

# Script to watch for PlantUML file changes and display previews with timg
# Usage: ./watch-puml.sh [directory]

WATCH_DIR="${1:-.}"
TEMP_DIR=$(mktemp -d)

trap 'rm -rf "$TEMP_DIR"' EXIT

# Check for required tools
for tool in inotifywait plantuml timg; do
    if ! command -v "$tool" &> /dev/null; then
        printf "Error: %s is not installed\n" "$tool" >&2
        exit 1
    fi
done

printf "Watching for .puml files in: %s\n" "$WATCH_DIR"
printf "Press Ctrl+C to stop\n"
printf "\n"

# Function to render and display a PlantUML file
render_and_display() {
    local puml_file="$1"
    local basename=$(basename "$puml_file" .puml)
    local output_png="$TEMP_DIR/${basename}.png"

    printf "[%s] Processing: %s\n" "$(date '+%H:%M:%S')" "$puml_file"

    # Render PlantUML to PNG
    if plantuml -tpng -o "$TEMP_DIR" "$puml_file" 2>&1; then
        # Display with timg
        if [ -f "$output_png" ]; then
            timg "$output_png"
            printf "\n"
        else
            printf "Error: Failed to generate %s\n" "$output_png" >&2
        fi
    else
        printf "Error: Failed to render %s\n" "$puml_file" >&2
    fi
}

# Initial render of all existing .puml files
shopt -s nullglob
for file in "$WATCH_DIR"/*.puml; do
    if [ -f "$file" ]; then
        render_and_display "$file"
    fi
done

# Watch for changes
inotifywait -m -e close_write,moved_to -r "$WATCH_DIR" --include '\.puml$' |
while read -r directory event filename; do
    if [[ "$filename" == *.puml ]]; then
        render_and_display "${directory}${filename}"
    fi
done
